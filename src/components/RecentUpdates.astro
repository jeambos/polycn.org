---
/* src/components/RecentUpdates.astro */
import { getCollection } from 'astro:content';

interface Props {
  /** * 可选：路径前缀过滤
   * 例如传入 'library/books/' 则只显示图书类的更新
   */
  idPrefix?: string;
}

const { idPrefix = '' } = Astro.props;

const allDocs = await getCollection('docs');

const recentDocs = allDocs
  .filter((doc) => !doc.id.startsWith('index'))
  // 1. 必须有 date 字段
  .filter((doc) => (doc.data as any).date)
  // 2. ✅ 新增逻辑：如果传入了前缀，只保留匹配该前缀的文档
  .filter((doc) => idPrefix ? doc.id.startsWith(idPrefix) : true)
  // 3. 排序 (新 -> 旧)
  .sort((a, b) => {
    const dateA = new Date((a.data as any).date).valueOf();
    const dateB = new Date((b.data as any).date).valueOf();
    return dateB - dateA;
  })
  .slice(0, 5); // 取前5篇
---

<div class="updates-card-container">
  <div class="updates-header">
    <h3>✨ 最近更新</h3>
    {/* 只有在显示全部更新时，才显示查看历史的链接，分区的历史比较少见 */}
    {!idPrefix && <a href="/timeline" class="view-all-link">查看历史 &rarr;</a>}
  </div>
  
  <div class="updates-list">
    {recentDocs.length === 0 ? (
      <div class="empty-state">暂无更新</div>
    ) : (
      recentDocs.map((doc) => {
        const data = doc.data as any;
        const dateStr = new Date(data.date).toLocaleDateString('zh-CN', { 
          month: '2-digit', 
          day: '2-digit' 
        });
        
        // 移除文件后缀生成链接
        const href = `/${doc.id.replace(/\.(md|mdx)$/, '')}/`;

        return (
          <a href={href} class="compact-update-item">
            <span class="update-title">{data.title}</span>
            <span class="update-date">{dateStr}</span>
          </a>
        );
      })
    )}
  </div>
</div>

<style>
  /* 样式保持不变，复用你之前的 CSS */
  .updates-card-container {
    background: var(--sl-color-gray-6);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 16px;
    padding: 1.2rem;
    height: 100%; /* ✅ 新增：为了在 Grid 布局中自动撑满高度 */
    display: flex;
    flex-direction: column;
  }

  .updates-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--sl-color-gray-5);
  }

  .updates-header h3 {
    font-size: 1.1rem;
    margin: 0;
    color: var(--sl-color-white);
  }

  .view-all-link {
    font-size: 0.85rem;
    color: var(--sl-color-gray-3);
    text-decoration: none;
  }
  .view-all-link:hover { color: var(--sl-color-accent); }

  .updates-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .compact-update-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.35rem 0.5rem;
    text-decoration: none;
    color: var(--sl-color-gray-2);
    border-radius: 6px;
    transition: all 0.2s;
  }

  .compact-update-item:hover {
    background: var(--sl-color-black);
    color: var(--sl-color-accent);
    padding-left: 0.8rem;
  }

  .update-title {
    font-size: 0.95rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 75%; 
    line-height: 1.2;
  }

  .update-date {
    font-size: 0.8rem;
    color: var(--sl-color-gray-4);
    font-family: monospace;
    opacity: 0.8;
  }
  
  .empty-state {
    text-align: center;
    color: var(--sl-color-gray-4);
    padding: 1rem;
    font-size: 0.9rem;
  }

  /* 第一篇文章高亮 */
  .updates-list a:first-child .update-title {
    color: var(--sl-color-accent);
    font-weight: bold;
  }
</style>